(function (t) {
  'object' == typeof exports && 'object' == typeof module
    ? t(require('../../lib/codemirror'))
    : 'function' == typeof define && define.amd
    ? define(['../../lib/codemirror'], t)
    : t(CodeMirror);
})(function (t) {
  function e(t) {
    return (t && t.bracketRegex) || /[(){}[\]]/;
  }
  function n(t, n, i) {
    var c = t.getLineHandle(n.line),
      a = n.ch - 1,
      s = i && i.afterCursor;
    null == s &&
      (s = /(^| )cm-fat-cursor($| )/.test(t.getWrapperElement().className));
    var h = e(i),
      u =
        (!s && a >= 0 && h.test(c.text.charAt(a)) && l[c.text.charAt(a)]) ||
        (h.test(c.text.charAt(a + 1)) && l[c.text.charAt(++a)]);
    if (!u) return null;
    var f = '>' == u.charAt(1) ? 1 : -1;
    if (i && i.strict && f > 0 != (a == n.ch)) return null;
    var m = t.getTokenTypeAt(o(n.line, a + 1)),
      g = r(t, o(n.line, a + (f > 0 ? 1 : 0)), f, m || null, i);
    return null == g
      ? null
      : {
          from: o(n.line, a),
          to: g && g.pos,
          match: g && g.ch == u.charAt(0),
          forward: f > 0,
        };
  }
  function r(t, n, r, i, c) {
    for (
      var a = (c && c.maxScanLineLength) || 1e4,
        s = (c && c.maxScanLines) || 1e3,
        h = [],
        u = e(c),
        f =
          r > 0
            ? Math.min(n.line + s, t.lastLine() + 1)
            : Math.max(t.firstLine() - 1, n.line - s),
        m = n.line;
      m != f;
      m += r
    ) {
      var g = t.getLine(m);
      if (g) {
        var d = r > 0 ? 0 : g.length - 1,
          k = r > 0 ? g.length : -1;
        if (!(g.length > a))
          for (m == n.line && (d = n.ch - (r < 0 ? 1 : 0)); d != k; d += r) {
            var p = g.charAt(d);
            if (
              u.test(p) &&
              (void 0 === i || t.getTokenTypeAt(o(m, d + 1)) == i)
            ) {
              var v = l[p];
              if (v && ('>' == v.charAt(1)) == r > 0) h.push(p);
              else {
                if (!h.length) return { pos: o(m, d), ch: p };
                h.pop();
              }
            }
          }
      }
    }
    return m - r != (r > 0 ? t.lastLine() : t.firstLine()) && null;
  }
  function i(t, e, r) {
    for (
      var i = t.state.matchBrackets.maxHighlightLineLength || 1e3,
        c = [],
        l = t.listSelections(),
        s = 0;
      s < l.length;
      s++
    ) {
      var h = l[s].empty() && n(t, l[s].head, r);
      if (h && t.getLine(h.from.line).length <= i) {
        var u = h.match
          ? 'CodeMirror-matchingbracket'
          : 'CodeMirror-nonmatchingbracket';
        c.push(
          t.markText(h.from, o(h.from.line, h.from.ch + 1), { className: u })
        ),
          h.to &&
            t.getLine(h.to.line).length <= i &&
            c.push(
              t.markText(h.to, o(h.to.line, h.to.ch + 1), { className: u })
            );
      }
    }
    if (c.length) {
      a && t.state.focused && t.focus();
      var f = function () {
        t.operation(function () {
          for (var t = 0; t < c.length; t++) c[t].clear();
        });
      };
      if (!e) return f;
      setTimeout(f, 800);
    }
  }
  function c(t) {
    t.operation(function () {
      t.state.matchBrackets.currentlyHighlighted &&
        (t.state.matchBrackets.currentlyHighlighted(),
        (t.state.matchBrackets.currentlyHighlighted = null)),
        (t.state.matchBrackets.currentlyHighlighted = i(
          t,
          !1,
          t.state.matchBrackets
        ));
    });
  }
  var a =
      /MSIE \d/.test(navigator.userAgent) &&
      (null == document.documentMode || document.documentMode < 8),
    o = t.Pos,
    l = {
      '(': ')>',
      ')': '(<',
      '[': ']>',
      ']': '[<',
      '{': '}>',
      '}': '{<',
      '<': '>>',
      '>': '<<',
    };
  t.defineOption('matchBrackets', !1, function (e, n, r) {
    function i(t) {
      t.state.matchBrackets &&
        t.state.matchBrackets.currentlyHighlighted &&
        (t.state.matchBrackets.currentlyHighlighted(),
        (t.state.matchBrackets.currentlyHighlighted = null));
    }
    r &&
      r != t.Init &&
      (e.off('cursorActivity', c), e.off('focus', c), e.off('blur', i), i(e)),
      n &&
        ((e.state.matchBrackets = 'object' == typeof n ? n : {}),
        e.on('cursorActivity', c),
        e.on('focus', c),
        e.on('blur', i));
  }),
    t.defineExtension('matchBrackets', function () {
      i(this, !0);
    }),
    t.defineExtension('findMatchingBracket', function (t, e, r) {
      return (
        (r || 'boolean' == typeof e) &&
          (r ? ((r.strict = e), (e = r)) : (e = e ? { strict: !0 } : null)),
        n(this, t, e)
      );
    }),
    t.defineExtension('scanForBracket', function (t, e, n, i) {
      return r(this, t, e, n, i);
    });
});
